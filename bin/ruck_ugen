#!/usr/bin/env ruby
$:.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require "ruck"
require "ruck/ugen"

# stuff accessible in a shred
module ShredLocal

  def blackhole
    BLACKHOLE
  end
  
  def now
    SHREDULER.now
  end

  def spork(name = "unnamed", &shred)
    SHREDULER.spork(name, &shred)
  end

  def play(samples)
    SHREDULER.current_shred.yield(samples)
  end

  def finish
    shred = SHREDULER.current_shred
    SHREDULER.remove_shred shred
    shred.finish
  end

end


SAMPLE_RATE = 22050
SHREDULER = Ruck::UGen::UGenShreduler.new
BLACKHOLE = Ruck::UGen::InChannel.new

filenames = ARGV
filenames.each do |filename|
  unless File.readable?(filename)
    LOG.fatal "Cannot read file #{filename}"
    exit
  end
end

filenames.each do |filename|
  SHREDULER.spork(filename) do
    include ShredLocal
    include Ruck::UGen::Generators
    require filename
  end
end
SHREDULER.run
